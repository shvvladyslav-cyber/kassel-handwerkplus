<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Handwerk+ — Kundenkonto</title>
  <meta name="theme-color" content="#0a0f22" />
  <link rel="stylesheet" href="../assets/styles.css">
  <link rel="manifest" href="../manifest.json">
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <a class="brand" href="../#home">
        <div class="logo" aria-hidden="true"></div>
        <span id="brandName">Handwerk+</span>
      </a>
      <div class="nav-links">
        <a href="../#home">← Site</a>
      </div>
      <div class="lang">
        <select id="langSelect" aria-label="Language"></select>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="card">
      <h1 id="title" class="section-title">Kundenkonto</h1>
      <p id="sub" class="section-sub"></p>

      <div class="grid" style="grid-template-columns:1fr 1fr">
        <label>
          <div id="lPhone" class="mini"></div>
          <input id="phone" placeholder="+49..." />
        </label>
        <label>
          <div id="lToken" class="mini"></div>
          <input id="token" placeholder="..." />
        </label>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
        <button id="btn" type="button">Load</button>
        <button id="demo" class="secondary" type="button">Demo</button>
      </div>

      <div style="height:12px"></div>
      <div id="empty" class="mini" style="display:none"></div>

      <div style="overflow:auto; margin-top:10px">
        <table class="table" id="table" style="display:none">
          <thead>
            <tr>
              <th id="thId">ID</th>
              <th id="thDate">Date</th>
              <th id="thCat">Category</th>
              <th id="thStatus">Status</th>
              <th id="thCity">City</th>
              <th id="thNote">Note</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <div class="t">Title</div>
    <div class="d">Desc</div>
  </div>

  <script src="../config.js"></script>
  <script>
  (async function(){
    const cfg = window.HANDWERKPLUS || {};
    const strings = await fetch('../i18n/strings.json').then(r=>r.json());
    const year = new Date().getFullYear();
    const state = { lang: (new URLSearchParams(location.search).get('lang')) || localStorage.getItem('lang') || cfg.DEFAULT_LANG || 'de' };
    if(!strings[state.lang]) state.lang='de';

    const $ = (s, el=document)=>el.querySelector(s);
    const $$ = (s, el=document)=>Array.from(el.querySelectorAll(s));

    function t(path){
      const parts = path.split('.');
      let cur = strings[state.lang];
      for(const p of parts){
        if(cur && Object.prototype.hasOwnProperty.call(cur,p)) cur=cur[p];
        else return path;
      }
      if(typeof cur === 'string') return cur.replace('{year}', String(year));
      return cur;
    }

    function setLang(lang){
      if(!strings[lang]) return;
      state.lang=lang;
      localStorage.setItem('lang', lang);
      render();
    }

    function toast(title, desc){
      const el = $('#toast');
      $('.t', el).textContent = title;
      $('.d', el).textContent = desc;
      el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), 4200);
    }

    function render(){
      document.documentElement.lang = state.lang;
      $('#brandName').textContent = cfg.BRAND || 'Handwerk+';
      $('#title').textContent = t('cabinet.title');
      $('#sub').textContent = t('cabinet.subtitle');
      const f = t('cabinet.fields');
      $('#lPhone').textContent = f.phone;
      $('#lToken').textContent = f.token;
      $('#btn').textContent = t('cabinet.btn');
      $('#demo').textContent = 'Demo';
      $('#empty').textContent = t('cabinet.empty');

      const th = t('cabinet.table');
      $('#thId').textContent = th.id;
      $('#thDate').textContent = th.date;
      $('#thCat').textContent = th.category;
      $('#thStatus').textContent = th.status;
      $('#thCity').textContent = th.city;
      $('#thNote').textContent = th.note;

      const sel = $('#langSelect');
      sel.innerHTML='';
      (cfg.SUPPORTED_LANGS||['de','ua','ru']).forEach(code=>{
        const opt=document.createElement('option');
        opt.value=code;
        opt.textContent = strings[code]?.langName || code.toUpperCase();
        sel.appendChild(opt);
      });
      sel.value=state.lang;
      sel.onchange = (e)=>setLang(e.target.value);
    }

    async function getLeads(phone, token){
      const url = cfg.APPS_SCRIPT_URL;
      if(!url || url.includes('PASTE_')) throw new Error('APPS_SCRIPT_URL not set');
      const q = new URLSearchParams({ action:'listLeads', phone: phone||'', token: token||'', lang: state.lang });
      const res = await fetch(url + '?' + q.toString(), { method:'GET' });
      const data = await res.json().catch(()=> ({}));
      if(!res.ok || data.ok === false) throw new Error(data.error || 'Request failed');
      return data.items || [];
    }

    function renderTable(items){
      const tb = $('#tbody');
      tb.innerHTML='';
      if(!items.length){
        $('#table').style.display='none';
        $('#empty').style.display='block';
        return;
      }
      $('#empty').style.display='none';
      $('#table').style.display='table';
      items.forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(it.id)}</td>
          <td>${esc(it.date || '')}</td>
          <td>${esc(it.category || '')}</td>
          <td><span class="pill">${esc(it.status || '')}</span></td>
          <td>${esc(it.city || '')}</td>
          <td>${esc(it.note || '')}</td>
        `;
        tb.appendChild(tr);
      });
    }

    function esc(s){
      return String(s ?? '').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }

    $('#btn').onclick = async ()=>{
      try{
        const items = await getLeads($('#phone').value.trim(), $('#token').value.trim());
        renderTable(items);
      }catch(err){
        toast('Error', String(err.message||err));
        console.warn(err);
      }
    };
    $('#demo').onclick = ()=>{
      renderTable([
        {id:'HW-0001', date:'2025-12-28', category:'Möbel', status:'IN_WORK', city:'Kassel', note:'Termin: Di 10:00'},
        {id:'HW-0002', date:'2025-12-27', category:'Bohr/Montage', status:'NEW', city:'Kassel', note:'Фото: link'}
      ]);
    };

    render();
  })();
  </script>
</body>
</html>
